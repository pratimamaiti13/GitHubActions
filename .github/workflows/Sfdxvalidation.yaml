name: sfdx-validation-on-PR
run-name: ${{ github.actor }} is learning GitHub Actions
on: 
  pull_request:
    types:
      - opened
      - reopened
    branches:
      - dev
jobs:
  sfdx-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout scm
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Print PR description
        run: echo "PR description is ${{ pull_request_comments }}"
      - name: Process test class
        run: |
          if [[ ${{ github.ref }} == *${ref}* ]]; then
          echo "version tag is........................"
          echo "Testclasses=dummyTestclasses" >> $GITHUB_ENV
          else
          echo "There is no github tag reference, skipping"
          echo "TestLevelValue=dummyTestLevelValue" >> $GITHUB_ENV
          fi
      - name: Print TestClasses
        run: |
          echo "TestClasses value: $Testclasses"
      - name: Install node js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      - run: |
          node --version
          npm --version
      - name: Install salesforce cli
        run: |
          wget https://developer.salesforce.com/media/salesforce-cli/sf/channels/stable/sf-linux-x64.tar.xz
          echo "present working directory is -----------------------"
          pwd
          mkdir -p ~/cli/sf
          tar xJf sf-linux-x64.tar.xz -C ~/cli/sf --strip-components 1
          echo "~/cli/sf/bin" >> $GITHUB_PATH
          ~/cli/sf/bin/sf --version 
      - name: Authorize with salesforce org
        run: |
          echo "${{ secrets.SERVER_KEY_FILE }}" > server.key
          sf auth:jwt:grant --instance-url https://login.salesforce.com/ --username pratimamaiti@nagarro.com --client-id 3MVG9pRzvMkjMb6kNn45Qi9K2FLiCMPaUlgi9jHEcgHqZSVlMWwhpHmn8T4VINYFTBYElbS0KV0GyvDfS2MOg --jwt-key-file server.key
      - name: Install sfdx git delta plugin
        run: echo y | sf plugins:install sfdx-git-delta
      - name: Display checked-out branch
        run: |
          echo "Checked-out branch: ${{ github.ref }}"
      - name: Create delta package for deployment
        run: |
          mkdir Delta
          git branch
          sf sgd:source:delta --to HEAD --from HEAD~1 --output Delta
          ls
          cat Delta/destructiveChanges/destructiveChanges.xml
          cat Delta/package/package.xml
      - name: Validation against salesforce
        run: |
          sf project deploy start --manifest Delta/package/package.xml --target-org pratimamaiti@nagarro.com --wait 20 --dry-run --json
